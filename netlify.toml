# ==============================================================================
# Configuration Netlify pour Next.js - Gestion Locative
# https://docs.netlify.com/integrations/frameworks/next-js/overview/
# ==============================================================================

[build]
  command = "npm run build"
  # Ne pas sp√©cifier publish - le plugin Next.js le g√®re automatiquement

# Plugin Next.js pour Netlify (requis)
[[plugins]]
  package = "@netlify/plugin-nextjs"

# ==============================================================================
# CONFIGURATION DU CACHE DE BUILD
# ==============================================================================
# Netlify cache automatiquement:
# - node_modules/ (restaur√© si package-lock.json n'a pas chang√©)
# - .next/cache/ (cache de compilation Next.js)
#
# Le plugin @netlify/plugin-nextjs g√®re automatiquement:
# - Le cache des pages statiques g√©n√©r√©es
# - Le cache des images optimis√©es
# - Les assets compil√©s
#
# Pour vider le cache manuellement:
# - Netlify UI > Deploys > Trigger deploy > Clear cache and deploy
# ==============================================================================

# Variables d'environnement de build
[build.environment]
  NODE_VERSION = "22"
  NPM_VERSION = "10"
  NETLIFY = "true"  # D√©sactive PWA sur Netlify
  # Optimisation du cache Next.js
  NEXT_TELEMETRY_DISABLED = "1"

# ==============================================================================
# VARIABLES D'ENVIRONNEMENT √Ä CONFIGURER DANS L'UI NETLIFY
# Site settings > Environment variables
# ==============================================================================
#
# üî¥ REQUISES:
#   - NEXT_PUBLIC_SUPABASE_URL
#   - NEXT_PUBLIC_SUPABASE_ANON_KEY
#   - SUPABASE_SERVICE_ROLE_KEY (üîí secret)
#   - API_KEY_MASTER_KEY (üîí secret)
#   - NEXT_PUBLIC_APP_URL (ex: https://votre-site.netlify.app)
#
# üü° OPTIONNELLES (selon fonctionnalit√©s activ√©es):
#   - OPENAI_API_KEY (üîí secret) - pour les fonctionnalit√©s IA
#   - STRIPE_SECRET_KEY (üîí secret) - pour les paiements
#   - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY - pour les paiements
#   - RESEND_API_KEY (üîí secret) - pour les emails
#   - TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN (üîí secrets) - pour les SMS
#   - NEXT_PUBLIC_SENTRY_DSN - pour le monitoring
#   - NEXT_PUBLIC_POSTHOG_KEY - pour les analytics
#
# ‚ö†Ô∏è  IMPORTANT: Les variables marqu√©es üîí sont secr√®tes et ne doivent
#     JAMAIS commencer par NEXT_PUBLIC_ pour √©viter l'exposition au client.
# ==============================================================================

# Headers de s√©curit√©
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# ==============================================================================
# HEADERS DE CACHE POUR ASSETS STATIQUES
# ==============================================================================

# Assets Next.js compil√©s (cache permanent - hashes dans les noms)
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Images optimis√©es par Next.js
[[headers]]
  for = "/_next/image/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"

# Fichiers statiques dans /public
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"

# Polices de caract√®res
[[headers]]
  for = "/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Fichiers manifest PWA et favicon
[[headers]]
  for = "/manifest.json"
  [headers.values]
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/favicon.ico"
  [headers.values]
    Cache-Control = "public, max-age=604800"

# Note: Les redirections sont g√©r√©es automatiquement par le plugin Next.js
# Pas besoin de les d√©finir manuellement

